<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="PHconsult - Admin Dashboard">
  <meta name="keywords" content="PHconsult, admin, dashboard, messages">
  <title>PHconsult - Admin Dashboard</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="icon" type="image/png" href="assets/images/Logo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
</head>
<body>
  <div class="side-panel">
    <h1>PHconsult</h1>
    <ul>
      <li><a href="index.html"><i class="fas fa-home"></i> <span>Home</span></a></li>
      <li><a href="about.html"><i class="fas fa-info-circle"></i> <span>About Us</span></a></li>
      <li><a href="services.html"><i class="fas fa-concierge-bell"></i> <span>Services</span></a></li>
      <li><a href="contact.html"><i class="fas fa-envelope"></i> <span>Contact</span></a></li>
      <li><a href="login.html"><i class="fas fa-sign-in-alt"></i> <span>Login</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <header class="container-fluid bg-light py-3">
      <div class="container d-flex justify-content-between align-items-center">
        <h1 class="text-primary">PHconsult Admin</h1>
        <button id="signOutBtn" class="btn btn-outline-danger">
          <i class="fas fa-sign-out-alt"></i> Sign Out
        </button>
      </div>
    </header>

    <div class="container mt-5">
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <h5 class="card-title">Total Messages</h5>
              <h2 id="totalMessages">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body">
              <h5 class="card-title">New Messages</h5>
              <h2 id="newMessages">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body">
              <h5 class="card-title">Read Messages</h5>
              <h2 id="readMessages">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body">
              <h5 class="card-title">Responded Messages</h5>
              <h2 id="respondedMessages">0</h2>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow">
        <div class="card-body">
          <h2 class="card-title mb-4">Messages</h2>
          <div class="table-responsive">
            <table id="messagesTable" class="table table-striped">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Subject</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Messages will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Message Details Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Message Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <p><strong>Name:</strong> <span id="modalName"></span></p>
                <p><strong>Email:</strong> <span id="modalEmail"></span></p>
                <p><strong>Phone:</strong> <span id="modalPhone"></span></p>
              </div>
              <div class="col-md-6">
                <p><strong>Date:</strong> <span id="modalDate"></span></p>
                <p><strong>Subject:</strong> <span id="modalSubject"></span></p>
                <p><strong>Status:</strong> <span id="modalStatus"></span></p>
              </div>
            </div>
            <div class="mb-3">
              <h6>Message:</h6>
              <p id="modalMessage" class="border p-3 rounded"></p>
            </div>
            <div class="mb-3">
              <label for="response" class="form-label">Response:</label>
              <textarea class="form-control" id="response" rows="4"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="markAsRead">Mark as Read</button>
            <button type="button" class="btn btn-success" id="sendResponse">Send Response</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="assets/js/script.js"></script>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  
  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCoFJWEc8z1Z-kddKR8T-QggAFCdm4Y7wI",
      authDomain: "daywise-ays8t.firebaseapp.com",
      projectId: "daywise-ays8t",
      storageBucket: "daywise-ays8t.firebasestorage.app",
      messagingSenderId: "690549644365",
      appId: "1:690549644365:web:d895858fbde5497b1c5004"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
  </script>
  
  <!-- Admin Dashboard Script -->
  <script>
    let currentMessageId = null;
    const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
    
    // Check authentication and admin status
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // Check if user is admin
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (!userDoc.exists || userDoc.data().role !== 'admin') {
        alert('Access denied. Admin privileges required.');
        window.location.href = 'index.html';
        return;
      }

      // Initialize DataTable
      const table = $('#messagesTable').DataTable({
        order: [[0, 'desc']], // Sort by date descending
        pageLength: 10,
        columns: [
          { data: 'date' },
          { data: 'name' },
          { data: 'email' },
          { data: 'subject' },
          { 
            data: 'status',
            render: function(data, type, row) {
              let badgeClass = 'bg-secondary';
              if (data === 'new') badgeClass = 'bg-danger';
              else if (data === 'read') badgeClass = 'bg-warning';
              else if (data === 'responded') badgeClass = 'bg-success';
              return `<span class="badge ${badgeClass}">${data}</span>`;
            }
          },
          {
            data: null,
            render: function(data, type, row) {
              return `
                <button class="btn btn-sm btn-primary view-message" data-id="${row.id}">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-danger delete-message" data-id="${row.id}">
                  <i class="fas fa-trash"></i>
                </button>
              `;
            }
          }
        ]
      });

      // Load messages
      loadMessages(table);

      // Set up real-time updates
      db.collection('messages')
        .orderBy('timestamp', 'desc')
        .onSnapshot((snapshot) => {
          loadMessages(table);
          updateStats();
        });
    });

    // Load messages into DataTable
    async function loadMessages(table) {
      const messages = [];
      const snapshot = await db.collection('messages').orderBy('timestamp', 'desc').get();
      
      snapshot.forEach(doc => {
        const data = doc.data();
        messages.push({
          id: doc.id,
          date: data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A',
          name: data.name,
          email: data.email,
          subject: data.subject,
          status: data.status || 'new',
          message: data.message,
          phone: data.phone || 'N/A'
        });
      });

      table.clear().rows.add(messages).draw();
    }

    // Update statistics
    async function updateStats() {
      const snapshot = await db.collection('messages').get();
      const messages = snapshot.docs.map(doc => doc.data());
      
      document.getElementById('totalMessages').textContent = messages.length;
      document.getElementById('newMessages').textContent = messages.filter(m => m.status === 'new').length;
      document.getElementById('readMessages').textContent = messages.filter(m => m.status === 'read').length;
      document.getElementById('respondedMessages').textContent = messages.filter(m => m.status === 'responded').length;
    }

    // View message details
    $(document).on('click', '.view-message', function() {
      const messageId = $(this).data('id');
      currentMessageId = messageId;
      
      db.collection('messages').doc(messageId).get().then(doc => {
        const data = doc.data();
        document.getElementById('modalName').textContent = data.name;
        document.getElementById('modalEmail').textContent = data.email;
        document.getElementById('modalPhone').textContent = data.phone || 'N/A';
        document.getElementById('modalDate').textContent = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A';
        document.getElementById('modalSubject').textContent = data.subject;
        document.getElementById('modalStatus').textContent = data.status || 'new';
        document.getElementById('modalMessage').textContent = data.message;
        document.getElementById('response').value = '';
        
        messageModal.show();
      });
    });

    // Mark message as read
    document.getElementById('markAsRead').addEventListener('click', async () => {
      if (!currentMessageId) return;
      
      try {
        await db.collection('messages').doc(currentMessageId).update({
          status: 'read',
          read: true
        });
        messageModal.hide();
      } catch (error) {
        console.error('Error updating message:', error);
        alert('Error updating message status');
      }
    });

    // Send response
    document.getElementById('sendResponse').addEventListener('click', async () => {
      if (!currentMessageId) return;
      
      const response = document.getElementById('response').value;
      if (!response) {
        alert('Please enter a response');
        return;
      }
      
      try {
        await db.collection('messages').doc(currentMessageId).update({
          status: 'responded',
          responded: true,
          response: response,
          responseDate: firebase.firestore.FieldValue.serverTimestamp()
        });
        messageModal.hide();
      } catch (error) {
        console.error('Error sending response:', error);
        alert('Error sending response');
      }
    });

    // Delete message
    $(document).on('click', '.delete-message', function() {
      const messageId = $(this).data('id');
      if (confirm('Are you sure you want to delete this message?')) {
        db.collection('messages').doc(messageId).delete()
          .then(() => {
            console.log('Message deleted successfully');
          })
          .catch(error => {
            console.error('Error deleting message:', error);
            alert('Error deleting message');
          });
      }
    });

    // Sign out
    document.getElementById('signOutBtn').addEventListener('click', async () => {
      try {
        await auth.signOut();
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Sign out error:', error);
        alert(error.message);
      }
    });
  </script>
</body>
</html> 