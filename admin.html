<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="PHconsult - Admin Dashboard">
  <meta name="keywords" content="PHconsult, admin, dashboard, messages">
  <title>PHconsult - Admin Dashboard</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="icon" type="image/png" href="assets/images/Logo.png">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
</head>
<body>
  <div class="side-panel">
    <h1>PHconsult</h1>
    <ul>
      <li><a href="index.html"><i class="fas fa-home"></i> <span>Home</span></a></li>
      <li><a href="about.html"><i class="fas fa-info-circle"></i> <span>About Us</span></a></li>
      <li><a href="services.html"><i class="fas fa-concierge-bell"></i> <span>Services</span></a></li>
      <li><a href="contact.html"><i class="fas fa-envelope"></i> <span>Contact</span></a></li>
      <li><a href="login.html"><i class="fas fa-sign-in-alt"></i> <span>Login</span></a></li>
    </ul>
  </div>

  <div class="main-content">
    <header class="container-fluid bg-light py-3">
      <div class="container d-flex justify-content-between align-items-center">
        <h1 class="text-primary">PHconsult Admin</h1>
        <button id="signOutBtn" class="btn btn-outline-danger">
          <i class="fas fa-sign-out-alt"></i> Sign Out
        </button>
      </div>
    </header>

    <div class="container mt-5">
      <!-- Tab Navigation -->
      <ul class="nav nav-tabs" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" type="button" role="tab" aria-controls="messages" aria-selected="true">Messages</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="donations-tab" data-bs-toggle="tab" data-bs-target="#donations" type="button" role="tab" aria-controls="donations" aria-selected="false">Donations</button>
        </li>
      </ul>
      <div class="tab-content" id="adminTabsContent">
        <div class="tab-pane fade show active" id="messages" role="tabpanel" aria-labelledby="messages-tab">
          <div class="row mb-4">
            <div class="col-12 text-end mb-3">
              <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#receiptModal">
                <i class="fas fa-receipt"></i> Create Receipt
              </button>
        </div>
      
        <div class="col-md-3">
          <div class="card bg-primary text-white">
            <div class="card-body">
              <h5 class="card-title">Total Messages</h5>
              <h2 id="totalMessages">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-success text-white">
            <div class="card-body">
              <h5 class="card-title">New Messages</h5>
              <h2 id="newMessages">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-warning text-white">
            <div class="card-body">
              <h5 class="card-title">Read Messages</h5>
              <h2 id="readMessages">0</h2>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card bg-info text-white">
            <div class="card-body">
              <h5 class="card-title">Responded Messages</h5>
              <h2 id="respondedMessages">0</h2>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow">
        <div class="card-body">
          <h2 class="card-title mb-4">Messages</h2>
          <div class="table-responsive">
            <table id="messagesTable" class="table table-striped">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Subject</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <!-- Messages will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
        </div>
        <div class="tab-pane fade" id="donations" role="tabpanel" aria-labelledby="donations-tab">
          <div class="card shadow mt-4">
            <div class="card-body">
              <h2 class="card-title mb-4">Donations</h2>
              <div class="table-responsive">
                <table id="donationsTable" class="table table-striped">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Donor Name</th>
                      <th>Donor Email</th>
                      <th>Amount</th>
                      <th>Currency</th>
                      <th>Transaction ID</th>
                      <th>Status</th>
                      <th>Receipt</th>
                      <th>Thank You Letter</th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- Donations will be loaded here -->
                    <!-- Thank You Letter buttons will be dynamically inserted by JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Thank You Letter Modal -->
    <div class="modal fade" id="thankYouLetterModal" tabindex="-1" aria-labelledby="thankYouLetterModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="thankYouLetterModalLabel">Thank You Letter</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="thankYouLetterContent" class="p-4 bg-white border rounded shadow-sm" style="max-width:600px; margin:auto; position:relative;">
              <img src="assets/images/BBA Logo.png" alt="BBA Logo" style="position:absolute; top:0; right:0; max-width:110px; max-height:80px; margin:8px 8px 0 0;">
              <div class="mb-2"><span id="tylDate"></span></div>
              <div class="mb-2">
                Attention: <span id="tylAttention"></span><br>
                <span id="tylOrg"></span>
              </div>
              <div class="mb-2">Dear <span id="tylDear"></span>,</div>
              <div class="mb-2">
                Thank you for your generous donation of <strong><span id="tylAmount"></span> <span id="tylCurrency"></span></strong> to the Black Biomechanists Association on <span id="tylDonationDate"></span>.<br><br>
                Your support helps us empower Black biomechanists at all experience levels. Thanks to contributions like yours, we continue to deliver impactful programming, including industry panels, mentoring, writing groups, and educational workshops at national biomechanics meetings.<br><br>
                We are grateful for your partnership and look forward to further collaboration.
              </div>
              <div class="mt-4">
                Sincerely,<br><br>
                <div style="display: flex; align-items: flex-end; justify-content: flex-start; gap: 40px;">
                  <div style="text-align: center;">
                    <img src="assets/images/Kayla sig.jpg" alt="Kayla Seymore Signature" style="max-width:120px; max-height:50px; display:block; margin:auto;">
                    <strong>Kayla Seymore</strong><br>
                    President, Black Biomechanists Association
                  </div>
                  <div style="text-align: center;">
                    <img src="assets/images/Matt sig.jpg" alt="Matthew B. A. McCullough Signature" style="max-width:120px; max-height:50px; display:block; margin:auto;">
                    <strong>Matthew B. A. McCullough, Ph.D.</strong><br>
                    Treasurer and Fundraising Chair, Black Biomechanists Association
                  </div>
                </div>
              </div>
              <div class="mt-4" style="font-size:0.96em; color:#444;">
                <hr>
                <p class="mb-0">
                  Your donation of <strong><span id="tylLegalAmount"></span></strong> was received on <strong><span id="tylLegalDate"></span></strong>.<br>
                  As the Black Biomechanists Association is a non-profit organization under section 501(c)3 of the federal tax code (EIN 86-3156801), and as you received no goods or services in exchange for this contribution, your donation may be tax deductible to the fullest extent of the law.<br>
                  You may wish to seek independent legal and tax advice regarding the deductibility of your gift. Please retain this letter for your tax records.
                </p>
              </div>
            </div>
            <div class="text-center mt-3">
              <button class="btn btn-outline-secondary me-2" id="printThankYouLetterBtn"><i class="fas fa-print"></i> Print</button>
              <button class="btn btn-outline-primary" id="downloadThankYouLetterBtn"><i class="fas fa-download"></i> Download PDF</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Donation Receipt Modal -->
    <div class="modal fade" id="donationReceiptModal" tabindex="-1" aria-labelledby="donationReceiptModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="donationReceiptModalLabel">Donation Receipt</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="donationReceiptContent" class="p-4 bg-white border rounded shadow-sm" style="max-width:600px; margin:auto;">
              <div class="text-center mb-3">
                <img src="assets/images/BBA Logo.png" alt="BBA Logo" style="max-width:120px;">
                <h4 class="mt-2">Black Biomechanists Association</h4>
                <p class="mb-1">Empowering Black biomechanists</p>
                <small>www.blackbiomechanists.org | EIN 86-3156801</small>
              </div>
              <hr>
              <div class="mb-2"><strong>Donor Name:</strong> <span id="donationDonorName"></span></div>
              <div class="mb-2"><strong>Donor Email:</strong> <span id="donationDonorEmail"></span></div>
              <div class="mb-2"><strong>Amount:</strong> <span id="donationAmount"></span> <span id="donationCurrency"></span></div>
              <div class="mb-2"><strong>Date:</strong> <span id="donationDate"></span></div>
              <div class="mb-2"><strong>Transaction ID:</strong> <span id="donationTxnId"></span></div>
              <div class="mb-2"><strong>Status:</strong> <span id="donationStatus"></span></div>
              <hr>
              <div class="text-center text-success fw-bold">Thank you for your generous donation!</div>

              <!-- Thank You Letter Removed: Now handled in a separate modal -->
            <div class="text-center mt-3">
              <button class="btn btn-outline-secondary me-2" id="printDonationReceiptBtn"><i class="fas fa-print"></i> Print</button>
              <button class="btn btn-outline-primary" id="downloadDonationReceiptBtn"><i class="fas fa-download"></i> Download PDF</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Receipt Modal -->
    <div class="modal fade" id="receiptModal" tabindex="-1" aria-labelledby="receiptModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="receiptModalLabel">Create Receipt</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="receiptForm">
              <div class="row mb-3">
                <div class="col-md-6">
                  <label for="clientName" class="form-label">Client Name</label>
                  <input type="text" class="form-control" id="clientName" required>
                </div>
                <div class="col-md-6">
                  <label for="organisation" class="form-label">Organisation</label>
                  <input type="text" class="form-control" id="organisation">
                </div>
                <div class="col-md-6">
                  <label for="service" class="form-label">Service Provided</label>
                  <input type="text" class="form-control" id="service" required>
                </div>
              </div>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="amount" class="form-label">Amount (GHS)</label>
                  <input type="number" class="form-control" id="amount" required min="0">
                </div>
                <div class="col-md-4">
                  <label for="paymentMethod" class="form-label">Payment Method</label>
                  <select class="form-control" id="paymentMethod" required>
                    <option value="Cash">Cash</option>
                    <option value="Mobile Money">Mobile Money</option>
                    <option value="Bank Transfer">Bank Transfer</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="receiptDate" class="form-label">Date</label>
                  <input type="date" class="form-control" id="receiptDate" required>
                </div>
              </div>
              <div class="text-end">
                <button type="submit" class="btn btn-primary">Generate Receipt</button>
              </div>
            </form>
            <hr>
            <div id="receiptPreview" style="display:none;">
              <div id="receiptContent" class="p-4 bg-white border rounded shadow-sm" style="max-width:600px; margin:auto;">
                <div class="text-center mb-3">
                  <img src="assets/images/Logo.png" alt="PHconsult Logo" style="max-width:120px;">
                  <h4 class="mt-2">PHconsult</h4>
                  <p class="mb-1">Professional Research Assistance</p>
                  <small>Accra, Ghana | phconsultgh@gmail.com | 055 199 3820</small>
                </div>
                <hr>
                <div class="mb-2"><strong>Date:</strong> <span id="previewDate"></span></div>
                <div class="mb-2"><strong>Receipt No.:</strong> <span id="previewReceiptNo"></span></div>
                <div class="mb-2"><strong>Client Name:</strong> <span id="previewClientName"></span></div>
                <div class="mb-2"><strong>Service:</strong> <span id="previewService"></span></div>
                <div class="mb-2"><strong>Amount:</strong> GHS <span id="previewAmount"></span></div>
                <div class="mb-2"><strong>Payment Method:</strong> <span id="previewPaymentMethod"></span></div>
                <hr>
                <div class="text-center text-success fw-bold">Thank you for choosing PHconsult!</div>
              </div>
              <div class="text-center mt-3">
                <button class="btn btn-outline-secondary me-2" id="printReceiptBtn"><i class="fas fa-print"></i> Print</button>
                <button class="btn btn-outline-primary" id="downloadReceiptBtn"><i class="fas fa-download"></i> Download PDF</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Message Details Modal -->
    <div class="modal fade" id="messageModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Message Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row mb-3">
              <div class="col-md-6">
                <p><strong>Name:</strong> <span id="modalName"></span></p>
                <p><strong>Email:</strong> <span id="modalEmail"></span></p>
                <p><strong>Phone:</strong> <span id="modalPhone"></span></p>
              </div>
              <div class="col-md-6">
                <p><strong>Date:</strong> <span id="modalDate"></span></p>
                <p><strong>Subject:</strong> <span id="modalSubject"></span></p>
                <p><strong>Status:</strong> <span id="modalStatus"></span></p>
              </div>
            </div>
            <div class="mb-3">
              <h6>Message:</h6>
              <p id="modalMessage" class="border p-3 rounded"></p>
            </div>
            <div class="mb-3">
              <label for="response" class="form-label">Response:</label>
              <textarea class="form-control" id="response" rows="4"></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="markAsRead">Mark as Read</button>
            <button type="button" class="btn btn-success" id="sendResponse">Send Response</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script src="assets/js/script.js"></script>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  
  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCoFJWEc8z1Z-kddKR8T-QggAFCdm4Y7wI",
      authDomain: "daywise-ays8t.firebaseapp.com",
      projectId: "daywise-ays8t",
      storageBucket: "daywise-ays8t.firebasestorage.app",
      messagingSenderId: "690549644365",
      appId: "1:690549644365:web:d895858fbde5497b1c5004"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    window.auth = auth;
    window.db = db;
  </script>
  
  <!-- Admin Dashboard Script -->
  <script src="assets/js/admin-receipt.js"></script>
  <!-- Admin Donations Script -->
  <script src="assets/js/admin-donations.js"></script>
  <script>
    let currentMessageId = null;
    const messageModal = new bootstrap.Modal(document.getElementById('messageModal'));
    
    // Check authentication and admin status
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      // Check if user is admin
      const userDoc = await db.collection('users').doc(user.uid).get();
      if (!userDoc.exists || userDoc.data().role !== 'admin') {
        alert('Access denied. Admin privileges required.');
        window.location.href = 'index.html';
        return;
      }

      // Initialize DataTable
      const table = $('#messagesTable').DataTable({
        order: [[0, 'desc']], // Sort by date descending
        pageLength: 10,
        columns: [
          { data: 'date' },
          { data: 'name' },
          { data: 'email' },
          { data: 'subject' },
          { 
            data: 'status',
            render: function(data, type, row) {
              let badgeClass = 'bg-secondary';
              if (data === 'new') badgeClass = 'bg-danger';
              else if (data === 'read') badgeClass = 'bg-warning';
              else if (data === 'responded') badgeClass = 'bg-success';
              return `<span class="badge ${badgeClass}">${data}</span>`;
            }
          },
          {
            data: null,
            render: function(data, type, row) {
              return `
                <button class="btn btn-sm btn-primary view-message" data-id="${row.id}">
                  <i class="fas fa-eye"></i>
                </button>
                <button class="btn btn-sm btn-danger delete-message" data-id="${row.id}">
                  <i class="fas fa-trash"></i>
                </button>
              `;
            }
          }
        ]
      });

      // Load messages
      loadMessages(table);

      // Set up real-time updates
      db.collection('messages')
        .orderBy('timestamp', 'desc')
        .onSnapshot((snapshot) => {
          loadMessages(table);
          updateStats();
        });
    });

    // Load messages into DataTable
    async function loadMessages(table) {
      const messages = [];
      const snapshot = await db.collection('messages').orderBy('timestamp', 'desc').get();
      
      snapshot.forEach(doc => {
        const data = doc.data();
        messages.push({
          id: doc.id,
          date: data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A',
          name: data.name,
          email: data.email,
          subject: data.subject,
          status: data.status || 'new',
          message: data.message,
          phone: data.phone || 'N/A'
        });
      });

      table.clear().rows.add(messages).draw();
    }

    // Update statistics
    async function updateStats() {
      const snapshot = await db.collection('messages').get();
      const messages = snapshot.docs.map(doc => doc.data());
      
      document.getElementById('totalMessages').textContent = messages.length;
      document.getElementById('newMessages').textContent = messages.filter(m => m.status === 'new').length;
      document.getElementById('readMessages').textContent = messages.filter(m => m.status === 'read').length;
      document.getElementById('respondedMessages').textContent = messages.filter(m => m.status === 'responded').length;
    }

    // View message details
    $(document).on('click', '.view-message', function() {
      const messageId = $(this).data('id');
      currentMessageId = messageId;
      
      db.collection('messages').doc(messageId).get().then(doc => {
        const data = doc.data();
        document.getElementById('modalName').textContent = data.name;
        document.getElementById('modalEmail').textContent = data.email;
        document.getElementById('modalPhone').textContent = data.phone || 'N/A';
        document.getElementById('modalDate').textContent = data.timestamp ? new Date(data.timestamp.toDate()).toLocaleString() : 'N/A';
        document.getElementById('modalSubject').textContent = data.subject;
        document.getElementById('modalStatus').textContent = data.status || 'new';
        document.getElementById('modalMessage').textContent = data.message;
        document.getElementById('response').value = '';
        
        messageModal.show();
      });
    });

    // Mark message as read
    document.getElementById('markAsRead').addEventListener('click', async () => {
      if (!currentMessageId) return;
      
      try {
        await db.collection('messages').doc(currentMessageId).update({
          status: 'read',
          read: true
        });
        messageModal.hide();
      } catch (error) {
        console.error('Error updating message:', error);
        alert('Error updating message status');
      }
    });

    // Send response
    document.getElementById('sendResponse').addEventListener('click', async () => {
      if (!currentMessageId) return;
      
      const response = document.getElementById('response').value;
      if (!response) {
        alert('Please enter a response');
        return;
      }
      
      try {
        await db.collection('messages').doc(currentMessageId).update({
          status: 'responded',
          responded: true,
          response: response,
          responseDate: firebase.firestore.FieldValue.serverTimestamp()
        });
        messageModal.hide();
      } catch (error) {
        console.error('Error sending response:', error);
        alert('Error sending response');
      }
    });

    // Delete message
    $(document).on('click', '.delete-message', function() {
      const messageId = $(this).data('id');
      if (confirm('Are you sure you want to delete this message?')) {
        db.collection('messages').doc(messageId).delete()
          .then(() => {
            console.log('Message deleted successfully');
          })
          .catch(error => {
            console.error('Error deleting message:', error);
            alert('Error deleting message');
          });
      }
    });

    // Sign out
    document.getElementById('signOutBtn').addEventListener('click', async () => {
      try {
        await auth.signOut();
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Sign out error:', error);
        alert(error.message);
      }
    });
  </script>
</body>
</html> 